Официальные ответы (ТЗ-решения)
1) Техническая архитектура

БД (сейчас/прод):

Dev/Replit: файловая JSON-БД (как сейчас) — оставить для быстрого старта.

Прод: PostgreSQL 14+. Слой DAO спроектировать так, чтобы переключение с файловой БД на Postgres было прозрачно (интерфейс репозитория).

Фронтенд:

На первом этапе остаёмся на vanilla HTML/JS (у нас уже готова логика).

Параллельно организовать структуру папок под возможную миграцию на React (src/components, src/pages с билдом Vite). Миграция — без изменения API.

Производительность (целевые):

До 10–15 тыс. инцидентов/мес по РК, одновременных активных пользователей 200–300.

Отчёт за месяц по «дереву» до 5 тыс. записей — < 3 сек.

Печать любой формы — < 2 сек после получения данных.

2) Функциональность

Импорт/экспорт:

Импорт XLSX/CSV инцидентов и пакетов (шаблоны предоставить).

Экспорт отчётов в XLSX + печать/«PDF через браузер».

Уведомления:

Email-уведомления (SMTP) при «Возврате» и «Утверждении» пакета. В dev — лог в консоль.

Аналитика/дашборды:

Набор диаграмм (Chart.js): тренды по месяцам, структура причин, карта по орг-уровням.

Сохранение пресетов периодов/фильтров на пользователя.

Мобильная версия:

Да, responsive (адаптив под 360–414 px). Таблицы — с горизонтальным скроллом.

3) Безопасность и администрирование

2FA: опционально TOTP (Google Authenticator) — включается для ролей reviewer/approver/admin.

Аудит: уже есть — дописать UI-раздел «Журнал» с фильтрами (действие, пользователь, период).

Права доступа (RBAC):

editor — ввод/редактирование в своей орг.

reviewer — просмотр по дереву, возврат пакетов детей.

approver — всё как reviewer + утверждение.

admin — полный доступ + управление оргами/пользователями.

Политика паролей: мин. 10 символов, сложность (буквы верх/низ, цифра, спецсимвол), срок действия 180 дней.

Токены: JWT exp=12h, refresh-модель не нужна; rate-limit на /auth/login (напр. 10 попыток/5 мин/ИП).

CORS: только домен деплоя (в dev — * допустимо).

Проверка orgId: строго по дереву пользователя (в репортах и формах уже внедрено — оставить).

4) Интеграции

Внешние системы: пока нет жёстких интеграций; предусмотреть REST-API /api/v1/... (стабильно версионированное).

КАТО/ОВСР: на втором этапе — загрузка официальных классификаторов (KATO, перечень ОВСР) из открытых данных; автоматическое определение «город/село» по КАТО.

5) Дизайн и UX

Стиль: деловой, «портал МЧС» — тёмная тема по умолчанию, переключатель светлая/тёмная.

Компоненты: лаконичный интерфейс, крупные элементы управления, подсказки (tooltips) у полей форм.

Диаграммы: интерактивные (hover, легенда, экспорт PNG).

Печатные формы: типографика, подписи, точность денег 0,1 тыс. тг, двуязычие позже (RU/KZ).

Что именно агенту сделать (конкретные указания)

Данные и хранилище

Оставить файловую БД на Replit (как в v2.0), вынести обращения в repository слой (/data/repo/*) с интерфейсами: IncidentsRepo, PackagesRepo, UsersRepo, OrgsRepo.

Добавить «переключатель» на Postgres (env DB_URL). Если задан — использовать pg и создавать таблицы миграцией.

Импорт/экспорт

/api/import/incidents (POST, XLSX/CSV, multipart) — парсер, валидация, dry-run и commit.

/api/export/report?form=1-osp&period=YYYY-MM&orgId=...&tree=true — XLSX с теми же данными, что печать.

Шаблоны XLSX положить в /public/templates/.

Уведомления

SMTP параметры через ENV (SMTP_HOST, SMTP_USER, SMTP_PASS, SMTP_FROM).

События: PACKAGE_RETURN, PACKAGE_APPROVE → письмо ответственному орг-уровня (email хранить у user).

Аналитика

/api/analytics уже есть — добавить:

byRegion (для дерева) — агрегация пожаров по детям.

lossTop — топ-N объектов по ущербу.

На фронте: 2 вкладки — «Тренды» и «Структура».

UX и печать

Переключатель темы (dark/light) с сохранением в localStorage.

Печатные формы: привести в единый стиль, добавить поля «Исполнитель», «Руководитель», «Дата», место для М.П.

Чёткое округление: все денежные поля до 0,1.

Валидации в UI

Вкладка «Отчёты» → блок «Ошибки» — таблица (код, описание, ссылка на инциденты).

Клик по ошибке — фильтрует список инцидентов источников.

Админка

Раздел «Журнал действий (Audit)» — таблица с фильтрами (дата от/до, пользователь, действие).

Модал «Создать пользователя»: пароль-генератор, проверка сложности, флаг «2FA (TOTP)».

Безопасность

Rate-limit логина.

2FA (TOTP) — таблица user_totp(secret, enabled); эндпоинты: включить/подтвердить/отключить; при включении — QR (otpauth://).

Ограничить includeChildren=true по ролям (оставить как в v2.0).

Справочники (строго по приказу)

data/enums/* заменить на полные перечни (возьмёт из наших Excel). Структура — плоский массив items с полными названиями пунктов.

Для 5-СПЖС наборы (reasons/conditions/places/objects) — чек-мультиселекты.

Производственные настройки

ENV: JWT_SECRET (required), ADMIN_PASSWORD, CORS_ORIGIN, SMTP-переменные.

/healthz и /readyz — для мониторинга.

Принятые критерии качества (что проверяем на приёмке)

Безопасность:

/api/reports?orgId=чужой и /forms/*?orgId=чужой → 403, если orgId вне дерева пользователя.

includeChildren=true — доступно только reviewer/approver/admin.

Rate-limit на логин работает (после 10 попыток блок на 5 минут).

Пакеты:

«Отправить вверх» у района → пакет виден области; «Сводный» у области собирает детей; РК видит сводные от областей.

Возврат с причиной — письмо и запись в Audit.

Отчёты и печать:

1-ОСП/2-ССГ/3-СПВП/4-СОВП/5-СПЖС/6-ССПЗ/CO печатаются, деньги в 0,1 тыс. тг.

Валидации: баланс 1-ОСП; ОВСР «в т.ч.» ≤ «всего»; детальные сообщения видны в UI.

Жилой сектор:

Множественные наборы сохраняются и агрегируются в 5-СПЖС.

Диаграммы:

Тренды по месяцам; круг по причинам; фильтры работают; экспорт PNG.

Импорт/экспорт:

Импорт XLSX валидируется (режим dry-run), ошибки показываются.

Экспорт XLSX выдаёт корректные суммы.

Адаптив:

Вёрстка корректна на 360 px (смартфон).