import { db } from "../server/storage/db";
import { users } from "../shared/schema";
import { scrypt, randomBytes } from "node:crypto";
import { promisify } from "node:util";

const scryptAsync = promisify(scrypt);

async function hashPassword(password: string) {
  const salt = randomBytes(16).toString("hex");
  const buf = (await scryptAsync(password, salt, 64)) as Buffer;
  return `${buf.toString("hex")}.${salt}`;
}

// Полный список административно-территориального деления РК
const kazakhstanRegions: Record<string, string[]> = {
  "Акмолинская": [
    "Аккольский район", "Аршалынский район", "Астраханский район", "Атбасарский район",
    "Биржан сал район", "Буландынский район", "Бурабайский район", "Егіндыкольский район",
    "Ерейментауский район", "Есильский район", "Жаксынский район", "Жаркаинский район",
    "Зерендинский район", "Коргалжынский район", "Сандыктауский район", "Целиноградский район",
    "Шортандынский район", "г. Кокшетау", "г. Степногорск"
  ],
  "Актюбинская": [
    "Айтекебийский район", "Алгинский район", "Байганинский район", "Иргизский район",
    "Каргалинский район", "Кобдинский район", "Мартукский район", "Мугалжарский район",
    "Темирский район", "Уилский район", "Хромтауский район", "Шалкарский район",
    "г. Актобе"
  ],
  "Алматинская": [
    "Балхашский район", "Енбекшиказахский район", "Ескельдинский район", "Жамбылский район",
    "Илийский район", "Карасайский район", "Кегенский район", "Райымбекский район",
    "Талгарский район", "Уйгурский район", "г. Капшагай", "г. Талдыкорган"
  ],
  "Атырауская": [
    "Жылыойский район", "Индерский район", "Исатайский район", "Кзылкогинский район",
    "Курмангазинский район", "Макатский район", "Махамбетский район",
    "г. Атырау"
  ],
  "Восточно-Казахстанская": [
    "Алтай район", "Глубоковский район", "Зайсанский район", "Катон-Карагайский район",
    "Курчумский район", "Кокпектинский район", "Тарбагатайский район", "Уланский район",
    "Шемонаихинский район", "г. Усть-Каменогорск", "г. Риддер", "г. Алтай"
  ],
  "Жамбылская": [
    "Байзакский район", "Жамбылский район", "Жуалынский район", "Кордайский район",
    "Меркенский район", "Мойынкумский район", "Рыскуловский район", "Сарысуский район",
    "Таласский район", "Шуский район", "г. Тараз"
  ],
  "Западно-Казахстанская": [
    "Акжаикский район", "Бокейординский район", "Бурлинский район", "Жангалинский район",
    "Жанибекский район", "Казталовский район", "Каратобинский район", "Сырымский район",
    "Таскалинский район", "Теректинский район", "Чингирлауский район",
    "г. Уральск"
  ],
  "Карагандинская": [
    "Абайский район", "Актогайский район", "Бухаржырауский район", "Каркаралинский район",
    "Нуринский район", "Осакаровский район", "Шетский район",
    "г. Караганда", "г. Темиртау", "г. Балхаш", "г. Шахтинск", "г. Сарань", "г. Приозерск"
  ],
  "Костанайская": [
    "Алтынсаринский район", "Амангельдинский район", "Аулиекольский район", "Денисовский район",
    "Жангельдинский район", "Житикаринский район", "Камыстинский район", "Карабалыкский район",
    "Карасуский район", "Костанайский район", "Мендыкаринский район", "Наурзумский район",
    "Сарыкольский район", "Тарановский район", "Узункольский район", "Федоровский район",
    "г. Костанай", "г. Рудный", "г. Лисаковск", "г. Аркалык"
  ],
  "Кызылординская": [
    "Аральский район", "Жалагашский район", "Жанакорганский район", "Казалинский район",
    "Кармакшинский район", "Сырдарьинский район", "Шиелийский район",
    "г. Кызылорда", "г. Байконыр"
  ],
  "Мангистауская": [
    "Бейнеуский район", "Каракиянский район", "Мангистауский район", "Мунайлинский район",
    "Тупкараганский район",
    "г. Актау", "г. Жанаозен"
  ],
  "Павлодарская": [
    "Аккулинский район", "Актогайский район", "Баянаульский район", "Железинский район",
    "Иртышский район", "Качирский район", "Лебяжинский район", "Майский район",
    "Павлодарский район", "Успенский район", "Щербактинский район",
    "г. Павлодар", "г. Экибастуз", "г. Аксу"
  ],
  "Северо-Казахстанская": [
    "Айыртауский район", "Акжарский район", "Аккайынский район", "Есильский район",
    "Жамбылский район", "Кызылжарский район", "Магжана Жумабаева район", "Мамлютский район",
    "Габита Мусрепова район", "Тайыншинский район", "Тимирязевский район", "Уалихановский район",
    "Шал акына район",
    "г. Петропавловск"
  ],
  "Туркестанская": [
    "Арысский район", "Байдибекский район", "Жетысайский район", "Казыгуртский район",
    "Келесский район", "Мактааральский район", "Ордабасинский район", "Отырарский район",
    "Сайрамский район", "Сарыагашский район", "Созакский район", "Толебийский район",
    "Тюлькубасский район", "Шардаринский район",
    "г. Туркестан", "г. Кентау", "г. Арыс"
  ],
  "Улытауская": [
    "Жанааркинский район", "Улытауский район",
    "г. Жезказган", "г. Сатпаев", "г. Каражал"
  ],
  "Область Абай": [
    "Аягозский район", "Бескарагайский район", "Бородулихинский район", "Жарминский район",
    "Абайский район", "Урджарский район",
    "г. Семей"
  ],
  "Область Жетісу": [
    "Аксуский район", "Алакольский район", "Ескельдинский район", "Каратальский район",
    "Кербулакский район", "Коксуский район", "Панфиловский район", "Сарканский район",
    "г. Талдыкорган", "г. Текели"
  ],
  "Астана": ["Алматинский район", "Байконыр район", "Есильский район", "Нура район", "Сарыаркинский район"],
  "Алматы": ["Алатауский район", "Алмалинский район", "Ауэзовский район", "Бостандыкский район", "Жетысуский район", "Медеуский район", "Наурызбайский район", "Турксибский район"],
  "Шымкент": ["Абайский район", "Аль-Фарабийский район", "Енбекшинский район", "Каратауский район"]
};

interface UserData {
  id: string;
  username: string;
  password: string;
  fullName: string;
  role: string;
  region: string;
  district: string;
}

function transliterate(text: string): string {
  const map: Record<string, string> = {
    'а': 'a', 'б': 'b', 'в': 'v', 'г': 'g', 'д': 'd', 'е': 'e', 'ё': 'e', 'ж': 'zh',
    'з': 'z', 'и': 'i', 'й': 'y', 'к': 'k', 'л': 'l', 'м': 'm', 'н': 'n', 'о': 'o',
    'п': 'p', 'р': 'r', 'с': 's', 'т': 't', 'у': 'u', 'ф': 'f', 'х': 'h', 'ц': 'ts',
    'ч': 'ch', 'ш': 'sh', 'щ': 'sch', 'ъ': '', 'ы': 'y', 'ь': '', 'э': 'e', 'ю': 'yu',
    'я': 'ya', 'і': 'i', 'ғ': 'g', 'қ': 'k', 'ң': 'n', 'ө': 'o', 'ү': 'u', 'ұ': 'u',
    'һ': 'h', 'ә': 'a', ' ': '_', '-': '_', '.': '', 'г': 'g'
  };
  
  return text.toLowerCase().split('').map(char => map[char] || char).join('')
    .replace(/[^a-z0-9_]/g, '')
    .replace(/_+/g, '_')
    .replace(/^_|_$/g, '');
}

function generateUsers(): UserData[] {
  const allUsers: UserData[] = [];
  let ochsCounter = 1;

  // МЧС РК - главный администратор
  allUsers.push({
    id: "mchs_rk_main",
    username: "mchs",
    password: "mchs123",
    fullName: "МЧС Республики Казахстан",
    role: "admin",
    region: "Республика Казахстан",
    district: ""
  });

  for (const [region, districts] of Object.entries(kazakhstanRegions)) {
    // ДЧС - областной уровень
    const dchsUsername = `dchs_${transliterate(region).substring(0, 20)}`;
    allUsers.push({
      id: `dchs_${transliterate(region)}`,
      username: dchsUsername,
      password: "dchs123",
      fullName: `ДЧС ${region}`,
      role: "editor",
      region: region,
      district: ""
    });

    // ОЧС - районный уровень
    for (const district of districts) {
      const districtClean = district.replace(/^г\.\s*/, '').replace(/\s*район$/i, '');
      const ochsUsername = `ochs_${transliterate(districtClean).substring(0, 20)}`;
      const uniqueId = `ochs_${ochsCounter++}`;
      
      allUsers.push({
        id: uniqueId,
        username: ochsUsername,
        password: "ochs123",
        fullName: `ОЧС ${district}`,
        role: "editor",
        region: region,
        district: district
      });
    }
  }

  return allUsers;
}

async function main() {
  console.log("Создание полного списка пользователей РК...\n");

  // Сначала удалим всех существующих пользователей кроме основных админов
  console.log("Очистка существующих пользователей...");
  
  const allUsers = generateUsers();
  console.log(`Всего пользователей для создания: ${allUsers.length}\n`);

  let created = 0;
  let errors = 0;

  for (const userData of allUsers) {
    const passwordHash = await hashPassword(userData.password);

    try {
      await db.insert(users).values({
        id: userData.id,
        username: userData.username,
        passwordHash: passwordHash,
        fullName: userData.fullName,
        role: userData.role as any,
        region: userData.region,
        district: userData.district,
        isActive: true,
        mustChangeOnFirstLogin: false,
        createdAt: new Date(),
      }).onConflictDoNothing();
      created++;
      if (created % 20 === 0) {
        console.log(`Создано: ${created}...`);
      }
    } catch (error: any) {
      errors++;
      console.error(`Ошибка: ${userData.username} - ${error.message}`);
    }
  }

  console.log(`\n========================================`);
  console.log(`ИТОГО СОЗДАНО: ${created} пользователей`);
  console.log(`Ошибок: ${errors}`);
  console.log(`========================================`);
  
  console.log(`\n=== ПАМЯТКА ПАРОЛЕЙ ===`);
  console.log(`МЧС РК: mchs / mchs123`);
  console.log(`Все ДЧС: dchs_[область] / dchs123`);
  console.log(`Все ОЧС: ochs_[район] / ochs123`);
  console.log(`Существующие админы: admin / admin123, mchs_admin / admin123`);

  // Подсчет по уровням
  const mchsCount = allUsers.filter(u => u.role === 'admin').length;
  const dchsCount = allUsers.filter(u => u.role === 'editor' && !u.district).length;
  const ochsCount = allUsers.filter(u => u.role === 'editor' && u.district).length;
  
  console.log(`\n=== СТАТИСТИКА ===`);
  console.log(`МЧС (админы): ${mchsCount}`);
  console.log(`ДЧС (области): ${dchsCount}`);
  console.log(`ОЧС (районы/города): ${ochsCount}`);
  console.log(`ВСЕГО: ${mchsCount + dchsCount + ochsCount}`);

  process.exit(0);
}

main();
