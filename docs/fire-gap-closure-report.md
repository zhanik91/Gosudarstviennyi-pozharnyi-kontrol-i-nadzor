# Fire gap closure report

## было

- Базовый контракт маппинга форм 1–7 был зафиксирован в `docs/fire-incident-form-matrix.md`, но не было единых контрольных сценариев, которые одновременно проверяют типы `fire`, `nonfire`, `steppe_fire`, `steppe_smolder`, `co_nofire` и сверяют ожидаемые/фактические значения строк формы. 
- Отдельные чувствительные зоны (`timeOfDay`, нормализация `locality`, маппинги `deathPlace/socialStatus/condition`, fallback для CO object mapping) были описаны как риски и требовали регрессионной проверки.

## сделано

### 1) Подготовлены контрольные сценарии по всем требуемым типам

Сценарии формализованы в `scripts/verify-fire-gap-closure.ts`:
- `fire` (жилой объект + пострадавшие типа `fire`),
- `nonfire`,
- `steppe_fire`,
- `steppe_smolder`,
- `co_nofire` (жертвы `co_poisoning` + неизвестный `objectCode` для fallback).

### 2) Для каждого сценария зафиксированы ожидаемые строки форм и выполнена сверка с фактом

Проверка делается автоматически: для каждого сценария и формы (`1-osp`, `2-ssg`, `3-spvp`, `4-sovp`, `5-spzs`, `6-sspz`, `co`) сравниваются ожидаемые поля строк с фактически рассчитанными `IncidentStorage.getReportFormData(...)`.

#### Сценарий `fire`

| Форма | Строка | Ожидание | Факт |
|---|---|---:|---:|
| 1-ОСП | `1` | `{total:1, urban:1, rural:0}` | совпало |
| 1-ОСП | `2` | `{total:100, urban:100, rural:0}` | совпало |
| 3-СПВП | `3`, `3.1` | `fires_total=1, damage_total=100` | совпало |
| 4-СОВП | `14.2` | `fires_total=1, damage_total=100, deaths_total=1, injuries_total=1` | совпало |
| 5-СПЖС | `2.1.1`, `3.1.1`, `5.1.3` | `urban=1` | совпало |

#### Сценарий `nonfire`

| Форма | Строка | Ожидание | Факт |
|---|---|---:|---:|
| 1-ОСП | `1` | `{total:1, urban:0, rural:1}` | совпало |
| 2-ССГ | `1` | `{value:1}` | совпало |

#### Сценарий `steppe_fire`

| Форма | Строка | Ожидание | Факт |
|---|---|---:|---:|
| 1-ОСП | `1` | `{total:1, urban:1, rural:0}` | совпало |
| 6-ССПЗ | `steppe:РК`, `steppe:г. Астана` | `fires_count=1, steppe_area=25, damage_total=300, people_total=3` | совпало |

#### Сценарий `steppe_smolder`

| Форма | Строка | Ожидание | Факт |
|---|---|---:|---:|
| 1-ОСП | `1` | `{total:1, urban:0, rural:1}` | совпало |
| 6-ССПЗ | `ignition:РК`, `ignition:г. Астана` | `fires_count=1, steppe_area=12, damage_total=70` | совпало |

#### Сценарий `co_nofire`

| Форма | Строка | Ожидание | Факт |
|---|---|---:|---:|
| 1-ОСП | `4`, `6` | `{total:1, urban:1, rural:0}` | совпало |
| 7-CO | `2.5`, `3.2`, `12.4`, `13.1` | соцстатус/состояние по погибшему и травмированному | совпало |
| 7-CO | `5.12`, `15.12` | fallback по неизвестному `objectCode` | совпало |
| 7-CO | `8.1`, `18.1` | time bucket из `dateTime=03:30` | совпало |

### 3) Отдельные целевые проверки

- `timeOfDay` только автоматический: в `co_nofire` сценарии `timeOfDay=null`, бакет берется из `dateTime` и попадает в `8.1/18.1`.
- Корректный разнос по `locality`: в `fire` проверен `city_pgt -> cities` (учет в `urban`), в `nonfire`/`steppe_smolder` — учет в `rural`.
- Корректность `deathPlace/socialStatus/condition`: 
  - форма 5 (`fire`): `2.1.1`, `3.1.1`, `5.1.3`;
  - форма 7-CO (`co_nofire`): `2.5`, `3.2`, `12.4`, `13.1`.
- Fallback по CO object mapping: `objectCode=unknown-code` корректно ушел в `5.12/15.12`.

## остаточные риски/ограничения

- Проверка выполняется на контролируемом in-memory наборе сценариев через переопределение `getReportDataset` и заглушку чтения `reportForms` для формы `1-osp`; это целенаправленная регрессия логики агрегации, но не end-to-end проверка с реальной БД/импортом форм.
- В сценариях проверяются ключевые строки (контрольные точки), а не 100% строк каждой формы; при изменении методологии форм рекомендуется расширять покрытие новыми строками в том же скрипте.
- Для формы 5 сохраняется методологический риск двойного учета детей (`2.3` из `incidents.deaths_children` + child-victim), ранее отмеченный в матрице; текущий набор сценариев его не снимает, а лишь фиксирует текущее поведение.

## фактический прогон проверок

В рамках финальной верификации были выполнены команды:

- `npm test` — успешно.
- `DATABASE_URL=postgres://user:pass@localhost:5432/db npx tsx scripts/verify-fire-gap-closure.ts` — успешно (`All checks passed`).
- `npm run check` — выявлены исторические TS-ошибки в несвязанных модулях (вынесено в техдолг, не блокирует целевую задачу по маппингу форм).

Для повторяемого запуска и критериев приемки см. `docs/fire-validation-runbook.md`.
